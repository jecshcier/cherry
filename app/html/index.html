<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>ebook3.0</title>
    <script type="text/x-mathjax-config">
    var mathId = document.getElementsByTagName('label')
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"] ],
        displayMath: [ ['$$','$$'], ["\\[","\\]"] ]
    }
});

    </script>
    <script type="text/javascript" async
            src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-MML-AM_CHTML">
    </script>
</head>
<style>
    body, h1, h2, h3, h4, h5, h6 {
        margin: 0;
        padding: 0;
    }

    h1 {
        margin-bottom: 50px;
    }
</style>
<body>
<h1>pdf2Text - based on cherry</h1>

<button onclick="chooseDir(this)" id="input-dir">选择存放pdf的文件夹</button>

<button onclick="chooseDir(this)" id="output-dir">请选择输出的文件夹</button>
<br><br>
<button onclick="readPdf(inputDir,outputDir)">开始生成文本文件(将跳过字符、标点、图片、公式，将用空格代替)</button>
<br><br>
<button onclick="readFormula()">读取公式文件</button>

<button onclick="cleanFormula()">清空公式</button>

<div id="formula-view"></div>


<h5 style="position: absolute;top: 0;right: 10px;">Author: ShayneC</h5>
</body>
<script>
    var inputDir = null;
    var outputDir = null;

    // 获取文件夹路径
    function chooseDir(_this, callback) {
        app.send('chooseDir', {
            callback: 'chooseDirCallback'
        })
        app.once('chooseDirCallback', function (event, mess) {
            if (callback) {
                console.log(mess)
                callback()
            }
            else
                console.log(_this)
            var dir = JSON.parse(mess).data
            _this.innerHTML = '已选择路径:' + dir
            if (_this.id === "input-dir") {
                inputDir = dir
            }
            else if (_this.id === "output-dir") {
                outputDir = dir
            }
        })
    }

    //读取pdf,生成text文件
    function readPdf(inputDir, outputDir) {
        if (!inputDir || !outputDir) {
            alert("请选择正确的文件")
            return false
        }
        app.send('readPdf', {
            callback: 'readPdfCallback',
            data: {
                inputDir: inputDir,
                outputDir: outputDir
            }
        })
        app.once('readPdfCallback', function (event, mess) {
            alert(mess)
        })
    }

    //读取公式
    function readFormula() {
        chooseFiles(function (url) {
            console.log(url)
            app.send('readFormula', {
                callback: 'readFormulaCallback',
                data: {
                    url: url
                }
            })
            app.once('readFormulaCallback', function (event, mess) {
                let obj = JSON.parse(mess)
                if (obj.flag) {
                    var formulaArr = obj.data
                    for (var i = 0; i < formulaArr.length; i++) {
                        var _label = document.createElement('label')
                        var _input = document.createElement('input')
                        var _br = document.createElement('br')
                        var _br2 = document.createElement('br')

                        _label.innerHTML = formulaArr[i] + ':'
                        _input.value = formulaArr[i]
                        document.getElementById('formula-view').appendChild(_label)
                        document.getElementById('formula-view').appendChild(_br)
                        document.getElementById('formula-view').appendChild(_input)
                        document.getElementById('formula-view').appendChild(_br2)
                    }
                    MathJax.Hub.Queue(["Typeset",MathJax.Hub,mathId]);
                }
                else {
                    alert(obj.message)
                }
            })
        })
    }
    
    function cleanFormula() {
        document.body.removeChild(document.getElementById('formula-view'))
        var _div = document.createElement('div')
        _div.id = 'formula-view'
        document.body.appendChild(_div)
    }

    // 获取文件路径队列
    function chooseFiles(callback) {
        app.send('chooseFiles', {
            callback: 'chooseFilesCallback'
        })
        app.once('chooseFilesCallback', function (event, mess) {
            if (callback) {
                console.log(mess)
                callback(JSON.parse(mess).data)
            }
            else
                alert(mess)
        })
    }
</script>
</html>
